![AQuA2-Cloud Logo](aqua2_cloud_website/assets/images/logoA.png)

AQuA2-Cloud is a online version of AQuA2 that runs in a docker container with network connectivity and capability for remote usage of AQuA2 and its core features. It uses the [MATLAB version of AQuA2](https://github.com/yu-lab-vt/AQuA2) as a logical
back-end with custom-wrapper enabled forwarding of the GUI state. Multiple simulatenous users are supported.

AQuA2-Cloud supports all functionality of AQuA2 **except** for:
- CFU Analysis
- Viewing 3D data

If you need to use any of the above features, you'll want to run AQuA2 locally on your machine. However, data files and results generated by AQuA2-Cloud are **directly compatible** with AQuA2. Therefore, you can do core/bulk 2D data analysis using AQuA2-Cloud then download and load the data files in your local AQuA2 program and conduct CFU analysis if such late-stage analysis is required. For 3D data, you'll want to use the standalone MATLAB version of AQuA2.

## AQuA2-Cloud Setup
**If you are simply updating your AQuA2-Cloud to the latest version, skip to step 4.**

This setup is to be conducted on the machine (the server) for which you'd like to run AQuA2-Cloud. Clients will only need a web-browser and FTP client later. For deploying AQuA2-Cloud, you will need Docker Engine.

Setup requires usage of a VNC client, for which there are two options for manner of usage...

**Option A:** Install a VNC Client on the server. This is valid if your server has remote desktop and a desktop environment for users.

**Option B:** Install a VNC Client on a LAN workstation, and allow connections from that workstation's IP address to the server, by specifying the workstation's IP address in the command line for the container's first time startup. Since you only need to connect via VNC client during the service's setup, workstation IP changes are irrelevant after the service is fully configured.

1. Install Docker Engine on host/server:

      **Windows:** Download and install Docker Desktop ([www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/))

      **Debian-based Linux:** Install docker engine via the command line interface (CLI). This code should work on most Debian-based linux distributions (Ubuntu, Linux Mint, Zorin, Kali, etc).

      ```console
      sudo apt-get update
      sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      ```

      **or...** Simply install Docker Engine using your distroâ€™s package manager.

2. Depending on your choice for how to go about the VNC client usage, either install your preferred VNC client on the server or on a LAN workstation of your choice.

3. Download this Github project and place the project folder somewhere on the host/server.

      **Windows**: Use the web-browser to download the project and file explorer to place the folder wherever you like. Or, use git to do so as shown below...

      **Linux**: 
      
      ```python
      git clone https://github.com/yu-lab-vt/AQuA2-Cloud.git
      cd AQuA2-Cloud

4. **Important:** AQuA2-Cloud uses MATLAB for the core application logic. You will need to download the MATLAB linux installer .zip and place it into the *matlab_installer* folder within the Github project folder. Go to
https://www.mathworks.com/downloads and login via your mathworks account that contains a license of matlab, and download a recent release for linux. It should download as a .zip file with name similar to format of "matlab_Rxxxxx_Linux.zip".

5. Set a root password for your container.

      The password is set by editing the *containerSetupSettings.txt* file prior to building the image. Change *changeme* to a root password that you will use. You can also customize your server here, including changing ports, the information used in a generated SSL certificate (you can also add your own certificate to the docker volume later), and setting the contact information that is displayed in the website. Below is an instructional guide and explanation for all of the parameters.

      ```
      AUTOMATIC_SETUP=true (Don't change)
      DEV_MODE=false (Leave disabled. If enabled, creates a testing user account with username testU and password testP)
      ROOT_PASS=changeme (Change)
      OPENSSH_SERVER_PORT=32 (The port to use for SSH connections)
      MATLAB_FILES_SKIP=false (Leave false. Skips checking if a matlab installer .zip file is present. The .zip file is copied into the container during image build, and setup will fail without it.)
      MYSQL_DATABASE_DIRECTORY="/mysql" (Leave as is. Determines the directory for MySQL database within the docker volume.)
      CLOUD_SERVER_IP_DOMAIN=127.0.0.1 (Replace with the IP or domain name that you'd like the server to respond to.)
      VSFTPD_SERVER_PORT=33 (The port that you'd like FTPS connections to be established on)
      VSFTPD_SERVER_PSV_MIN_PORT=50000 (FTPS needs a range of ports to direct incoming connections to after handshake. This port is the begginning of the range.)
      VSFTPD_SERVER_PSV_MAX_PORT=50009 (This port is the end of the range.)
      SSL_COUNTRY="US" (The country listed on the auto generated SSL certificate. This must be only two letters.)
      SSL_STATE="State" (The state listed on the auto generated SSL certificate.)
      SSL_LOCALITY="City" (The city listed on the auto generated SSL certificate.)
      SSL_ORG="Organization" (The organization listed on the auto generated SSL certificate.)
      APACHE_LOG_DIR="/apache_server_logs" (Where to save logs generated by the web server)
      CONTACTPERSON1NAME="person1name"
      CONTACTPERSON1INFO="person1info"
      CONTACTPERSON1EMAIL="person1email"
      CONTACTPERSON2NAME="person2name"
      CONTACTPERSON2INFO="person2info"
      CONTACTPERSON2EMAIL="person2email
      CONTACTPERSON3NAME="person3name"
      CONTACTPERSON3INFO="person3info"
      CONTACTPERSON3EMAIL="person3email"
      CREATE_GUEST_ACCOUNTS=false (If enabled, generate 5 guest accounts with names "guest1" through "guest5". Each account has a unique generated password, and passwords are saved in *guest_accounts.txt* in the docker volume.)
      ```

6. **Make sure you did steps 4 and 5 first.** Create the AQuA2-Cloud image.

      First, navigate to the project folder in an administrative/root terminal if you haven't already done so. Then, run:

      ```python
      docker build -t aqua2-cloud .
      ```


7. Modify the following command as needed to properly configure your container. Ensure ports defined are correct (example: if you changed SSH port from 32 to 42 in step 5, change 32:32 to 42:42 in the command below). If you elected for option B for how to go about using the VNC client, change the IP address for the VNC port mapping to the IP address of your LAN workstation (i.e. change 127.0.0.1:5900:5900 to xxx.xxx.xxx.xxx:5900:5900 where xxx.xxx.xxx.xxx is the LAN workstation address). Running this command will use the AQuA2-Cloud image created in step 6 to automatically create a container, create a docker volume (if it doesn't already exist) for storing user data, and to deploy the service. The container by default uses port 32 for local host-to-container SSH connections. You can always delete the container (**don't delete the docker volume**), download the latest github project folder, rebuild the image, and redeploy to update AQuA2-Cloud to to the latest version without losing any user data (files or website accounts).

      ```python
      docker run --cpus="24" --memory="64G" -it --restart=unless-stopped -p 127.0.0.1:32:32 -p 80:80 -p 127.0.0.1:5900:5900 -p 443:443 -p 33:33 -p 50000-50009:50000-50009 -v aqua2-cloud-data:/opt/a2ud --tmpfs /mnt/matlab_ramdisk:rw,exec,size=8g --name aqua2-cloud-container aqua2-cloud
      ```

8. Follow the instructions given by the container during first time setup. You will need to connect to the container via the VNC client to interactively login to MATLAB and select the toolboxes required by AQuA2-Cloud. You will have to login a total of 2 times. If you run the VNC client on the hosting machine the connection address will be 127.0.0.1:5900, otherwise, you may have to allow access to port 5900 over LAN in order to connect to the container on the server.

9. Setup any specific firewall rules you might need. All ports utilized by the service are shown in the command line in step 7, so whatever the port numbers are, those will be the port numbers you should inspect your server's firewall configuration for.

## MATLAB License Renewal or Change

1. Just delete and redeploy the container. User data is persisted between deployments. Use VNC client to follow the matlab setup process again, which will include logging into a mathworks account with a valid license.

## Cloud service user management

You can run the following commands after connecting to the container as root via SSH. Replace <root_password> with the container root password where applicable, or enter root password when asked.

### List users
```
mysql -u root -p
Use AQuA2_Cloud_Database;
SELECT * FROM users'
exit
```
### Verify user
```
/usr/local/bin/verify_user.sh <root_password> <the_user_username>
```
### Remove user
```
/usr/local/bin/remove_user.sh <root_password> <the_user_username>
```
### Delete a user's data (Be careful with this command)

List user folders first and check for the user data you're looking into deleting...
```
ls /opt/a2ud/user_data
```

You can delete a users data by replacing <the_user_username> with the username of the user
```
sudo rm -rf /opt/a2ud/user_data/<the_user_name>
```

### Change user password
```
/usr/local/bin/change_user_password.sh <root_password> <the_user_username> <their_new_password>
```
## Website SSL certificate

An auto-generated certificate that is self-signed is used for the website and FTPS server. It is located at /opt/a2ud/aqua2_cloud_ssl_certificate in the container.

If you want to host this service in a publicly accessible manner, you'll want to have your certificate signed by a certificate authority. This will remove the exclamation mark on the padlock next to the url bar when users access the website in a web browser. After logging into your container as root over SSH, use the following commands to get a signed certificate. Replace <CLOUD_SERVER_IP_DOMAIN> with your IP or domain.

```
service apache2 stop
certbot certonly --standalone -d <CLOUD_SERVER_IP_DOMAIN>
cp /etc/letsencrypt/live/<CLOUD_SERVER_IP_DOMAIN>/fullchain.pem /opt/a2ud/aqua2_cloud_ssl_certificate/aqua2_cloud_certificate.crt
cp /etc/letsencrypt/live/<CLOUD_SERVER_IP_DOMAIN>/privkey.pem /opt/a2ud/aqua2_cloud_ssl_certificate/aqua2_cloud_certificate.key
service apache2 start
```

This certificate is good for 3 months. After which, you'll have to run this command set again.

